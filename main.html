<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master SV Editor - Google Drive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root { --accent: #2196f3; --red: #ff5252; --green: #4caf50; --dark: #1a1a1a; }
        body { margin: 0; height: 100vh; display: flex; font-family: -apple-system, sans-serif; overflow: hidden; background: #000; }
        #sidebar { width: 340px; height: 100%; position: relative; background: #fff; z-index: 2000; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .panel { position: absolute; top:0; left:0; width:100%; height:100%; display: flex; flex-direction: column; background: #fff; transition: 0.3s; z-index: 10; }
        .panel.hidden { display: none; }
        .point-header { padding: 8px 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; cursor: pointer; }
        .point-header.active { background: #fff1f0; border-left: 5px solid var(--red); }
        .btn-edit-sm { background: var(--accent); color: white; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; font-size: 10px; opacity: 0.7; }
        .hs-tree { padding-left: 30px; background: #fafafa; display: none; }
        .hs-tree.show { display: block; }
        .pnlm-hotspot-base { background: none !important; border: none !important; width: auto !important; height: auto !important; }
        .hs-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; text-shadow: 0 1px 4px #000; cursor: pointer; }
        .pnlm-drag-active { opacity: 0.5; filter: drop-shadow(0 0 10px yellow); }
        #main-content { flex: 1; position: relative; z-index: 1; }
        #viewer, #map-full { position: absolute; top:0; left:0; width:100%; height:100%; }
        #map-full { z-index: 5; visibility: hidden; background: #eee; }
        #viewer { z-index: 10; }
        #main-content.map-active #map-full { visibility: visible; z-index: 20; }
        .scroll { flex: 1; overflow-y: auto; padding: 15px; }
        input, select, button { width: 100%; margin-bottom: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .master-zone { background: #fff1f0; padding: 10px; border: 1px solid #ffa39e; border-radius: 8px; margin-bottom: 10px; }
        .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-bottom: 10px; }
        .icon-btn { padding: 6px; border: 1px solid #eee; border-radius: 4px; text-align: center; cursor: pointer; background: #f9f9f9; font-size: 18px; }
        .icon-btn.active { border-color: var(--accent); background: #e3f2fd; }
        .color-dot { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }
        .adj-box { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 6px; border-radius: 6px; margin-bottom: 6px; }
        .adj-btn { width: 28px; height: 28px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; }
        .marker-red { filter: hue-rotate(150deg) saturate(2); z-index: 1000 !important; }
        .upload-zone { background: #f0f7ff; border: 2px dashed var(--accent); border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 10px; cursor: pointer; }
        .upload-zone:hover { background: #e3f2fd; }
        .upload-zone.uploading { opacity: 0.6; pointer-events: none; }
        .status-msg { padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 12px; }
        .status-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50; }
        .status-error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .gdrive-login { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .gdrive-status { padding: 8px 12px; background: #e8f5e9; border-radius: 8px; font-size: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
<div id="sidebar">
    <!-- Login Panel -->
    <div id="panel-login" class="panel">
        <div class="scroll" style="display: flex; align-items: center; justify-content: center;">
            <div class="gdrive-login">
                <h2 style="text-align: center; color: #1a1a1a;">üó∫Ô∏è Master SV Editor</h2>
                <p style="text-align: center; color: #666; font-size: 14px;">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Drive ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                <button id="loginBtn" onclick="handleAuth()" style="background: #4285f4; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>üîê</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
                </button>
                <div style="font-size: 11px; color: #999; text-align: center; margin-top: 10px;">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå "PanoramaDB" ‡∏ö‡∏ô Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </div>
            </div>
        </div>
    </div>

    <!-- List Panel -->
    <div id="panel-list" class="panel hidden">
        <div style="padding:15px; border-bottom:1px solid #eee;">
            <div class="gdrive-status">
                <span>‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive</span>
                <button onclick="handleSignout()" style="margin: 0; padding: 4px 8px; font-size: 11px; width: auto; background: #ff5252; color: white;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <button style="background:var(--green); color:white; font-weight:bold; margin-bottom:10px;" onclick="addNewPoint()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î Panorama ‡πÉ‡∏´‡∏°‡πà</button>
            <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Hotspot..." oninput="renderTree()">
        </div>
        <div class="scroll" id="treeRoot"></div>
        <div style="padding:15px;">
            <button onclick="saveToGDrive()" style="background:var(--dark); color:white; font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Drive</button>
            <button onclick="reloadFromGDrive()" style="background:#666; color:white; font-weight:bold; margin-top:5px;">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Drive</button>
        </div>
    </div>

    <!-- Edit Panel -->
    <div id="panel-edit" class="panel hidden">
        <div style="padding:15px; border-bottom:1px solid #ddd;">
            <button onclick="exitEdit()" style="background:var(--accent); color:white; border:none; padding:10px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer;">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
        </div>
        <div class="scroll">
            <div id="statusBox"></div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</label><input id="pName" type="text" oninput="updateName()">
            <label>üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ Panorama</label>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <div>üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û 360</div>
                <div style="font-size:11px; color:#666; margin-top:5px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB)</div>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="uploadToGDrive()">
            <div id="currentImage" style="font-size:11px; color:#666; margin-bottom:10px;"></div>
            <button style="background:#ef6c00; color:white;" onclick="saveStartView()">üì∏ ‡∏•‡πá‡∏≠‡∏Ñ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
            <hr>
            <div class="master-zone">
                <button id="masterEditBtn" style="background:var(--dark); color:white; font-weight:bold;" onclick="toggleMasterEdit()">üõ†Ô∏è Master HotSpot Edit: OFF</button>
            </div>
            <h4 style="margin:10px 0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Hotspots</h4>
            <div id="hsTreeEdit"></div>
            <button style="color:red; border:1px solid red; background:none; margin-top:30px; font-size:12px;" onclick="deletePoint()">üóëÔ∏è ‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>
        </div>
    </div>
</div>

<div id="main-content">
    <div style="position:absolute; bottom:20px; right:20px; z-index:1001;">
        <button onclick="switchView()" style="padding:12px 24px; border-radius:30px; background:var(--dark); color:white; border:none; cursor:pointer; font-weight:bold;">üó∫Ô∏è Switch Map/360</button>
    </div>
    <div id="map-full"></div>
    <div id="viewer"></div>
</div>

<!-- Hotspot Modal -->
<div id="hsModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:15px; z-index:3000; width:330px; box-shadow:0 15px 50px rgba(0,0,0,0.5);">
    <h3 style="margin-top:0">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Hotspot</h3>
    <select id="mType" onchange="toggleMFields()">
        <option value="info">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</option>
        <option value="scene">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏≠‡∏∑‡πà‡∏ô</option>
        <option value="url">üåê ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</option>
    </select>
    <div id="mSceneBox" style="display:none;"><label>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î:</label><select id="mTarget"></select></div>
    <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á:</label><input id="mText" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å">
    <div id="mUrlBox" style="display:none;"><label>URL:</label><input id="mUrl" type="text" placeholder="https://..."></div>
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Icon:</label>
    <div class="icon-grid" id="iconPalette">
        <div class="icon-btn active" onclick="selI('',this)">‚úñ</div>
        <div class="icon-btn" onclick="selI('‚¨ÜÔ∏è',this)">‚¨ÜÔ∏è</div><div class="icon-btn" onclick="selI('‚¨áÔ∏è',this)">‚¨áÔ∏è</div>
        <div class="icon-btn" onclick="selI('‚¨ÖÔ∏è',this)">‚¨ÖÔ∏è</div><div class="icon-btn" onclick="selI('‚û°Ô∏è',this)">‚û°Ô∏è</div>
        <div class="icon-btn" onclick="selI('üè¢',this)">üè¢</div><div class="icon-btn" onclick="selI('üè†',this)">üè†</div>
        <div class="icon-btn" onclick="selI('üöª',this)">üöª</div><div class="icon-btn" onclick="selI('üö™',this)">üö™</div>
    </div>
    <input type="hidden" id="mIcon" value="">
    <div class="adj-box"><span>Icon Size: <b id="iSizeVal">24</b>px</span>
        <div><button class="adj-btn" onclick="adjVal('mIconSize', -2, 'iSizeVal')">-</button><button class="adj-btn" onclick="adjVal('mIconSize', 2, 'iSizeVal')">+</button></div>
    </div>
    <input type="hidden" id="mIconSize" value="24">
    <div class="adj-box"><span>Font Size: <b id="fSizeVal">14</b>px</span>
        <div><button class="adj-btn" onclick="adjVal('mFontSize', -1, 'fSizeVal')">-</button><button class="adj-btn" onclick="adjVal('mFontSize', 1, 'fSizeVal')">+</button></div>
    </div>
    <input type="hidden" id="mFontSize" value="14">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ:</label>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div class="color-dot" style="background:#ffffff" onclick="selC('#ffffff',this)"></div>
        <div class="color-dot" style="background:#ffeb3b" onclick="selC('#ffeb3b',this)"></div>
        <div class="color-dot" style="background:#ff5252" onclick="selC('#ff5252',this)"></div>
        <div class="color-dot" style="background:#2196f3" onclick="selC('#2196f3',this)"></div>
    </div>
    <input type="hidden" id="mColor" value="#ffffff">
    <button onclick="saveHS()" style="background:var(--accent); color:white; font-weight:bold;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button onclick="document.getElementById('hsModal').style.display='none'" style="background:none; border:none; color:gray; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

<script>
// ========================================
// Google Drive API Configuration
// ========================================
const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com'; // ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const API_KEY = 'YOUR_API_KEY'; // ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
const FOLDER_NAME = 'PanoramaDB';
const DB_FILENAME = 'panorama_data.json';

let gapiInited = false;
let gisInited = false;
let tokenClient;
let accessToken = null;
let folderID = null;
let dbFileID = null;

// ========================================
// Application State
// ========================================
let data = [];
let curId = null;
let viewer = null;
let map, markers = [];
let editMode = false;
let masterEdit = false;
let isDragging = false;
let dragIdx = null;
let currentView = 'viewer';
let editingIdx = null;

// ========================================
// Google API Initialization
// ========================================
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: DISCOVERY_DOCS,
    });
    gapiInited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
    });
    gisInited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('loginBtn').disabled = false;
    }
}

function handleAuth() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        accessToken = gapi.client.getToken().access_token;
        await initializeApp();
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignout() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        accessToken = null;
        folderID = null;
        dbFileID = null;
        showLoginPanel();
    }
}

function showLoginPanel() {
    document.getElementById('panel-login').classList.remove('hidden');
    document.getElementById('panel-list').classList.add('hidden');
    document.getElementById('panel-edit').classList.add('hidden');
}

function showListPanel() {
    document.getElementById('panel-login').classList.add('hidden');
    document.getElementById('panel-list').classList.remove('hidden');
    document.getElementById('panel-edit').classList.add('hidden');
}

// ========================================
// Google Drive Functions
// ========================================
async function findOrCreateFolder() {
    try {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
        const response = await gapi.client.drive.files.list({
            q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        if (response.result.files.length > 0) {
            folderID = response.result.files[0].id;
            console.log('‚úÖ ‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå:', folderID);
        } else {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
            const fileMetadata = {
                name: FOLDER_NAME,
                mimeType: 'application/vnd.google-apps.folder'
            };
            const folder = await gapi.client.drive.files.create({
                resource: fileMetadata,
                fields: 'id'
            });
            folderID = folder.result.id;
            console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà:', folderID);
        }
        return folderID;
    } catch (error) {
        console.error('Error finding/creating folder:', error);
        throw error;
    }
}

async function findDBFile() {
    try {
        const response = await gapi.client.drive.files.list({
            q: `name='${DB_FILENAME}' and '${folderID}' in parents and trashed=false`,
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        if (response.result.files.length > 0) {
            dbFileID = response.result.files[0].id;
            console.log('‚úÖ ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', dbFileID);
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error finding DB file:', error);
        return false;
    }
}

async function loadDataFromGDrive() {
    try {
        const hasDB = await findDBFile();
        if (!hasDB) {
            console.log('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á');
            data = [];
            return;
        }

        const response = await gapi.client.drive.files.get({
            fileId: dbFileID,
            alt: 'media'
        });

        data = JSON.parse(response.body);
        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', data.length, '‡∏à‡∏∏‡∏î');
    } catch (error) {
        console.error('Error loading data:', error);
        data = [];
    }
}

async function saveToGDrive() {
    try {
        showStatus('success', '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Drive...');
        
        const jsonData = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        
        const metadata = {
            name: DB_FILENAME,
            mimeType: 'application/json',
            parents: [folderID]
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);

        let url, method;
        if (dbFileID) {
            url = `https://www.googleapis.com/upload/drive/v3/files/${dbFileID}?uploadType=multipart`;
            method = 'PATCH';
        } else {
            url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            method = 'POST';
        }

        const response = await fetch(url, {
            method: method,
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            body: form
        });

        const result = await response.json();
        if (!dbFileID) dbFileID = result.id;
        
        showStatus('success', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏•‡∏á Google Drive!');
        console.log('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data.length, '‡∏à‡∏∏‡∏î');
    } catch (error) {
        console.error('Error saving:', error);
        showStatus('error', '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
    }
}

async function uploadToGDrive() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (!file) return;

    if (file.size > 50 * 1024 * 1024) {
        showStatus('error', '‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB');
        return;
    }

    const uz = document.getElementById('uploadZone');
    uz.classList.add('uploading');
    uz.innerHTML = '<div>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...</div>';
    showStatus('success', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive...');

    try {
        const metadata = {
            name: `pano_${Date.now()}_${file.name}`,
            mimeType: file.type,
            parents: [folderID]
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webContentLink,webViewLink', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken
            },
            body: form
        });

        const result = await response.json();
        
        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô public
        await gapi.client.drive.permissions.create({
            fileId: result.id,
            resource: {
                role: 'reader',
                type: 'anyone'
            }
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ
        const imageUrl = `https://drive.google.com/uc?export=view&id=${result.id}`;
        
        const p = data.find(x => x.id === curId);
        p.image = imageUrl;
        p.gdriveFileId = result.id;
        
        showStatus('success', '‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        updateImageDisplay();
        loadViewer();
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        setTimeout(() => saveToGDrive(), 500);
    } catch (error) {
        console.error('Upload error:', error);
        showStatus('error', '‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
    } finally {
        uz.classList.remove('uploading');
        uz.innerHTML = '<div>üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û 360</div><div style="font-size:11px">JPG, PNG (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB)</div>';
        fileInput.value = '';
    }
}

async function reloadFromGDrive() {
    if (confirm('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Google Drive? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)')) {
        await loadDataFromGDrive();
        renderTree();
        if (curId) {
            const p = data.find(x => x.id === curId);
            if (p) loadViewer(p.startPitch, p.startYaw);
            else exitEdit();
        }
        showStatus('success', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Drive ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }
}

// ========================================
// Application Initialization
// ========================================
async function initializeApp() {
    await findOrCreateFolder();
    await loadDataFromGDrive();
    
    map = L.map('map-full', {attributionControl: false}).setView([13.75, 100.5], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    showListPanel();
    renderTree();
}

// ========================================
// UI Functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
// ========================================
function updateImageDisplay() {
    const p = data.find(x => x.id === curId);
    const box = document.getElementById('currentImage');
    if (p && p.image) {
        box.innerHTML = `<strong>‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏ô Google Drive ‡πÅ‡∏•‡πâ‡∏ß`;
    } else {
        box.innerHTML = '<em style="color:#999">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</em>';
    }
}

function showStatus(type, msg) {
    const box = document.getElementById('statusBox');
    const cls = type === 'success' ? 'status-success' : 'status-error';
    box.innerHTML = `<div class="status-msg ${cls}">${msg}</div>`;
    setTimeout(() => { box.innerHTML = '' }, 5000);
}

function renderTree() {
    const root = document.getElementById('treeRoot');
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    root.innerHTML = '';
    
    const filtered = data.filter(p => {
        const mP = p.name.toLowerCase().includes(query);
        const mHS = (p.hotSpots || []).some(h => (h.text || "").toLowerCase().includes(query));
        return query === "" || mP || mHS;
    });
    
    filtered.forEach(p => {
        const wrap = document.createElement('div');
        wrap.className = 'point-item';
        const isExp = query !== "" || p.id === curId ? "show" : "";
        wrap.innerHTML = `
            <div class="point-header ${p.id === curId ? 'active' : ''}">
                <span style="flex:1" onclick="selectPoint('${p.id}');toggleTree('${p.id}')">üìç ${p.name}</span>
                <button class="btn-edit-sm" onclick="event.stopPropagation();enterEdit('${p.id}')">‚úèÔ∏è</button>
            </div>
            <div id="tree
