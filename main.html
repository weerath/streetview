<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>Drive Only App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Google -->
<script src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>

<!-- 360 Viewer -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif}
#top{padding:8px;background:#000}
#viewer{width:100%;height:calc(100vh - 45px)}
button{margin-right:5px}
</style>
</head>
<body>

<div id="top">
<button onclick="login()">Login Google</button>
<button onclick="loadDB()">Load</button>
<button onclick="saveDB()">Save</button>
<input type="file" accept="image/*" onchange="uploadImage(this.files[0])">
<span id="status"></span>
</div>

<div id="viewer"></div>

<script>
/* ===== CONFIG ===== */
const CLIENT_ID = "740899492808-qoi3pjpfbe2sp8e8e4q43tr2sm0cnuhl.apps.googleusercontent.com";
const FOLDER_ID = "1PQWNipWJ3f6HvS_g8j3eC4_eKJ7NVC79";
const SCOPES = "https://www.googleapis.com/auth/drive.file";

let tokenClient, accessToken;
let db = [];
let viewer;

/* ===== GOOGLE INIT ===== */
gapi.load("client", async()=>{
  await gapi.client.init({
    discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
  });
});

tokenClient = google.accounts.oauth2.initTokenClient({
  client_id: CLIENT_ID,
  scope: SCOPES,
  callback:t=>{
    accessToken=t.access_token;
    gapi.client.setToken(t);
    log("Login OK");
  }
});

function login(){ tokenClient.requestAccessToken(); }

/* ===== DRIVE ===== */
async function findFile(name){
  const r = await gapi.client.drive.files.list({
    q:`'${FOLDER_ID}' in parents and name='${name}' and trashed=false`
  });
  return r.result.files[0];
}

async function loadDB(){
  const f = await findFile("data.json");
  if(!f){ db=[]; log("DB empty"); return; }
  const r = await fetch(
    `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`,
    {headers:{Authorization:`Bearer ${accessToken}`}}
  );
  db = await r.json();
  if(db[0]?.image) show360(db[0].image);
  log("Loaded "+db.length);
}

async function saveDB(){
  const body = JSON.stringify(db,null,2);
  let f = await findFile("data.json");

  if(!f){
    await gapi.client.drive.files.create({
      resource:{name:"data.json",parents:[FOLDER_ID]},
      media:{mimeType:"application/json",body}
    });
  }else{
    await gapi.client.request({
      path:`/upload/drive/v3/files/${f.id}`,
      method:"PATCH",
      params:{uploadType:"media"},
      body
    });
  }
  log("Saved");
}

async function uploadImage(file){
  const meta={name:file.name,parents:[FOLDER_ID]};
  const fd=new FormData();
  fd.append("metadata",new Blob([JSON.stringify(meta)],{type:"application/json"}));
  fd.append("file",file);

  const r = await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",
    {method:"POST",headers:{Authorization:`Bearer ${accessToken}`},body:fd}
  );
  const j = await r.json();
  const url = `https://drive.google.com/uc?id=${j.id}`;

  db.push({id:Date.now(),image:url,hotspots:[]});
  show360(url);
  log("Image uploaded");
}

/* ===== VIEWER ===== */
function show360(url){
  if(viewer) viewer.destroy();
  viewer = pannellum.viewer("viewer",{
    type:"equirectangular",
    panorama:url,
    autoLoad:true
  });
}

function log(t){status.innerText=t;}
</script>
</body>
</html>
