<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>SV Editor â€“ Drive Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">

<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff}
#bar{padding:10px;background:#000}
button{margin-right:5px}
#viewer{width:100%;height:calc(100vh - 50px)}
</style>
</head>
<body>

<div id="bar">
<button onclick="login()">Login Google</button>
<button onclick="loadDB()">Load</button>
<button onclick="saveDB()">Save</button>
<input type="file" accept="image/*" onchange="uploadImage(this.files[0])">
<span id="msg"></span>
</div>

<div id="viewer"></div>

<script>
/* ===== CONFIG ===== */
const CLIENT_ID = "YOUR_CLIENT_ID";
const FOLDER_ID = "YOUR_FOLDER_ID";
const SCOPES = "https://www.googleapis.com/auth/drive.file";

let tokenClient, accessToken;
let data = [];
let viewer;

/* ===== GOOGLE INIT ===== */
gapi.load("client", async()=>{
  await gapi.client.init({
    discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
  });
});

tokenClient = google.accounts.oauth2.initTokenClient({
  client_id: CLIENT_ID,
  scope: SCOPES,
  callback: t=>{
    accessToken=t.access_token;
    gapi.client.setToken(t);
    msg("Login OK");
  }
});

function login(){ tokenClient.requestAccessToken(); }

/* ===== DRIVE ===== */
async function findFile(name){
  const r = await gapi.client.drive.files.list({
    q:`'${FOLDER_ID}' in parents and name='${name}' and trashed=false`
  });
  return r.result.files[0];
}

async function loadDB(){
  const f = await findFile("data.json");
  if(!f){ data=[]; msg("Empty DB"); return; }
  const r = await fetch(`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`,
    {headers:{Authorization:`Bearer ${accessToken}`}}
  );
  data = await r.json();
  if(data[0]?.image) loadViewer(data[0].image);
  msg("Loaded "+data.length);
}

async function saveDB(){
  const body = JSON.stringify(data,null,2);
  let f = await findFile("data.json");

  if(!f){
    await gapi.client.drive.files.create({
      resource:{name:"data.json",parents:[FOLDER_ID]},
      media:{mimeType:"application/json",body}
    });
  }else{
    await gapi.client.request({
      path:`/upload/drive/v3/files/${f.id}`,
      method:"PATCH",
      params:{uploadType:"media"},
      body
    });
  }
  msg("Saved");
}

async function uploadImage(file){
  const meta={name:file.name,parents:[FOLDER_ID]};
  const fd=new FormData();
  fd.append("metadata",new Blob([JSON.stringify(meta)],{type:"application/json"}));
  fd.append("file",file);

  const r = await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",
    {method:"POST",headers:{Authorization:`Bearer ${accessToken}`},body:fd}
  );
  const j = await r.json();
  const url=`https://drive.google.com/uc?id=${j.id}`;
  data.push({id:Date.now(),name:file.name,image:url});
  loadViewer(url);
  msg("Uploaded");
}

/* ===== VIEW ===== */
function loadViewer(url){
  if(viewer) viewer.destroy();
  viewer = pannellum.viewer("viewer",{type:"equirectangular",panorama:url,autoLoad:true});
}
function msg(t){document.getElementById("msg").innerText=t;}
</script>
</body>
</html>
