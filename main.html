<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>360 VR Editor Pro - Test Mode</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --accent: #007bff; --red: #dc3545; --dark: #212529; --test: #ffc107; }
        body { margin: 0; height: 100vh; display: flex; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; }
        #sidebar { width: 350px; height: 100%; background: #ffffff; z-index: 2000; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
        #map-container { height: 250px; width: 100%; border-bottom: 1px solid #dee2e6; }
        .panel { padding: 20px; overflow-y: auto; flex-grow: 1; }
        #viewer-container { flex-grow: 1; position: relative; background: #000; }
        #viewer { width: 100%; height: 100%; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .list-item { padding: 12px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .list-item:hover { background: #f8f9fa; border-left: 4px solid var(--accent); }
        .edit-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:10; display:none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .upload-zone { border: 2px dashed #ddd; padding: 20px; border-radius: 8px; text-align: center; background: #f8f9fa; cursor: pointer; }
        .progress-bar { width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .status-text { font-size: 0.85em; color: var(--accent); text-align: center; margin-top: 8px; font-weight: bold; }
        .preview-img { max-width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 10px; }
        .test-badge { background: var(--test); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; position: absolute; top: 10px; right: 10px; z-index: 3000; font-weight: bold; }
    </style>
</head>
<body>

<div id="test-indicator" class="test-badge" style="display:none;">üõ† TEST MODE (No Database)</div>

<div id="sidebar">
    <div id="map-container"></div>
    <div class="panel">
        <h3 style="margin-top:0;">üìç ‡∏à‡∏∏‡∏î‡∏ñ‡πà‡∏≤‡∏¢ 360¬∞</h3>
        <button class="btn btn-primary" onclick="addNewPoint()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà</button>
        <div id="tree-list" style="margin-top: 15px;"></div>
    </div>

    <div id="edit-panel" class="edit-overlay">
        <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î</h3>
        <input type="text" id="pName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." style="width:100%; padding:10px; margin-bottom: 20px;" oninput="updateName()">
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 30px;">‚òÅÔ∏è Drive</div>
            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive</p>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
            <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
            <div id="uploadStatus" class="status-text"></div>
            <img id="previewImg" class="preview-img" style="display:none;">
        </div>
        <button class="btn" style="background:#f1f1f1; margin-top:20px;" onclick="exitEdit()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="btn" style="background:var(--red); color:white;" onclick="deletePoint()">üóëÔ∏è ‡∏•‡∏ö</button>
    </div>
</div>

<div id="viewer-container">
    <div id="viewer"></div>
</div>

<script>
// --- CONFIGURATION ---
const IS_TEST_MODE = true; // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Firebase/Drive ‡∏à‡∏£‡∏¥‡∏á ***

const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    appId: "YOUR_APP_ID"
};
const GAS_WEBAPP_URL = "YOUR_GAS_URL"; 

// Global Variables
let db, map, viewer, dataList = [], curId = null;

window.onload = () => {
    if (IS_TEST_MODE) {
        document.getElementById('test-indicator').style.display = 'block';
        loadMockData();
    } else {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        loadFirebaseData();
    }
    initMap();
};

function initMap() {
    map = L.map('map-container', { attributionControl: false }).setView([13.75, 100.5], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    map.on('click', (e) => {
        if (curId) updateData(curId, { lat: e.latlng.lat, lon: e.latlng.lng });
    });
}

// --- DATA MANAGEMENT ---
function loadMockData() {
    dataList = [
        { id: '1', name: '‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß (Demo)', lat: 13.7515, lon: 100.4927, image: 'https://pannellum.org/images/alma.jpg' },
        { id: '2', name: '‡πÄ‡∏™‡∏≤‡∏ä‡∏¥‡∏á‡∏ä‡πâ‡∏≤ (Demo)', lat: 13.7517, lon: 100.5012, image: '' }
    ];
    refreshUI();
}

function loadFirebaseData() {
    db.ref('points').on('value', (snap) => {
        const val = snap.val();
        dataList = val ? Object.keys(val).map(key => ({...val[key], id: key})) : [];
        refreshUI();
    });
}

function updateData(id, payload) {
    if (IS_TEST_MODE) {
        const idx = dataList.findIndex(p => p.id === id);
        if (idx !== -1) {
            dataList[idx] = { ...dataList[idx], ...payload };
            refreshUI();
        }
    } else {
        db.ref(`points/${id}`).update(payload);
    }
}

function refreshUI() {
    renderTree();
    updateMapMarkers();
}

// --- UI LOGIC ---
function renderTree() {
    const list = document.getElementById('tree-list');
    list.innerHTML = dataList.map(p => `
        <div class="list-item" onclick="enterEdit('${p.id}')">
            <span>üìç ${p.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</span>
            <span>${p.image ? '‚úÖ' : '‚ö™'}</span>
        </div>
    `).join('');
}

function updateMapMarkers() {
    map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
    dataList.forEach(p => {
        L.marker([p.lat, p.lon]).addTo(map).on('click', () => enterEdit(p.id));
    });
}

async function handleFileUpload(input) {
    const file = input.files[0];
    if (!file || !curId) return;

    const status = document.getElementById('uploadStatus');
    const progress = document.getElementById('progressBar');
    const fill = document.getElementById('progressFill');

    status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
    progress.style.display = 'block';
    fill.style.width = '30%';

    if (IS_TEST_MODE) {
        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        setTimeout(() => {
            fill.style.width = '100%';
            status.innerText = "‚úÖ Test Mode: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
            const mockImg = "https://pannellum.org/images/cerro-toco-0.jpg";
            updateData(curId, { image: mockImg });
            update360Viewer(mockImg);
            document.getElementById('previewImg').src = mockImg;
            document.getElementById('previewImg').style.display = 'block';
            setTimeout(() => { progress.style.display = 'none'; }, 1000);
        }, 1500);
    } else {
        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏á‡πÑ‡∏õ Google Drive ‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ)
        try {
            const base64Data = await compressAndConvertToBase64(file);
            const response = await fetch(GAS_WEBAPP_URL, {
                method: 'POST',
                body: JSON.stringify({ base64: base64Data, fileName: file.name, mimeType: "image/jpeg" })
            });
            const result = await response.json();
            if(result.status === "success") {
                updateData(curId, { image: result.url });
                update360Viewer(result.url);
            }
        } catch (e) { status.innerText = "‚ùå Error: " + e.message; }
    }
}

function update360Viewer(url) {
    if (viewer) viewer.destroy();
    if (!url) {
        document.getElementById('viewer').innerHTML = '<div style="color:white;text-align:center;padding-top:20%;">üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ 360</div>';
        return;
    }
    viewer = pannellum.viewer('viewer', {
        type: "equirectangular",
        panorama: url,
        autoLoad: true,
        crossOrigin: "anonymous"
    });
}

function enterEdit(id) {
    curId = id;
    const p = dataList.find(x => x.id === id);
    document.getElementById('edit-panel').style.display = 'block';
    document.getElementById('pName').value = p.name || '';
    const preview = document.getElementById('previewImg');
    if (p.image) { preview.src = p.image; preview.style.display = 'block'; }
    else { preview.style.display = 'none'; }
    update360Viewer(p.image);
    map.panTo([p.lat, p.lon]);
}

function addNewPoint() {
    const center = map.getCenter();
    const newId = IS_TEST_MODE ? Date.now().toString() : db.ref('points').push().key;
    const newPoint = { id: newId, name: "‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà " + (dataList.length + 1), lat: center.lat, lon: center.lng, image: "" };
    
    if (IS_TEST_MODE) {
        dataList.push(newPoint);
        refreshUI();
    } else {
        db.ref(`points/${newId}`).set(newPoint);
    }
    setTimeout(() => enterEdit(newId), 300);
}

function updateName() {
    const name = document.getElementById('pName').value;
    if (curId) updateData(curId, { name: name });
}

function deletePoint() {
    if (!confirm('‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ?')) return;
    if (IS_TEST_MODE) {
        dataList = dataList.filter(p => p.id !== curId);
        refreshUI();
    } else {
        db.ref(`points/${curId}`).remove();
    }
    exitEdit();
}

function exitEdit() {
    document.getElementById('edit-panel').style.display = 'none';
    curId = null;
    update360Viewer(null);
}

function compressAndConvertToBase64(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = Math.min(img.width, 2048);
                canvas.height = canvas.width / (img.width/img.height);
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}
</script>
</body>
</html>
