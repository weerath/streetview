<!DOCTYPE html>
<html lang="th">
<head>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<div id="sidebar">
    <div style="padding: 10px; background: #f0f0f0;">
        <button id="auth_btn" class="btn btn-blue" onclick="handleAuthClick()">üîë ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive</button>
    </div>
    </div>

<script>
// --- CONFIGURATION ---
const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'YOUR_API_KEY';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

const firebaseConfig = { /* ... ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ... */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
// ---------------------

let tokenClient;
let gapiInited = false;
let gisInited = false;

// 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Google Auth
function gapiLoaded() {
    gapi.load('client', async () => {
        await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true;
    });
}
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: '', // ‡∏à‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
    });
    gisInited = true;
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw (resp);
        document.getElementById('auth_btn').innerText = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
    };
    tokenClient.requestAccessToken({prompt: 'consent'});
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Local ‡πÑ‡∏õ Google Drive
async function uploadToDrive(file) {
    const metadata = {
        'name': `panorama_${Date.now()}.jpg`,
        'mimeType': 'image/jpeg'
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth.getToken().access_token }),
            body: form
        });
        const fileData = await response.json();
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Public (Anyone with the link) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Pannellum ‡πÑ‡∏î‡πâ
        await gapi.client.drive.permissions.create({
            fileId: fileData.id,
            resource: { role: 'reader', type: 'anyone' }
        });

        return fileData.id;
    } catch (err) {
        console.error('Upload error:', err);
        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Drive');
    }
}

// 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Edit)
async function handleLocalFileSelect(event) {
    const file = event.target.files[0];
    if (!file || !curId) return;

    showStatus('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive...', '#ff9800');
    
    const driveId = await uploadToDrive(file);
    if (driveId) {
        const directLink = `https://docs.google.com/uc?export=view&id=${driveId}`;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
        const p = data.find(x => x.id === curId);
        p.image = directLink;
        
        db.ref('points').set(data)
            .then(() => {
                showStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '#4caf50');
                loadViewer(directLink);
            });
    }
}

// ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô HTML ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
// <input type="file" id="localFileInput" style="display:none" onchange="handleLocalFileSelect(event)">
// <button class="btn btn-blue" onclick="document.getElementById('localFileInput').click()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>

</script>
</body>
</html>
