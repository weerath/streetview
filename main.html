<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>360 VR Editor Pro - Google Drive & Firebase</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --accent: #007bff; --red: #dc3545; --dark: #212529; }
        body { margin: 0; height: 100vh; display: flex; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: #000; }
        
        /* Sidebar */
        #sidebar { width: 350px; height: 100%; background: #ffffff; z-index: 2000; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
        #map-container { height: 250px; width: 100%; border-bottom: 1px solid #dee2e6; }
        .panel { padding: 20px; overflow-y: auto; flex-grow: 1; }
        
        /* Viewer */
        #viewer-container { flex-grow: 1; position: relative; background: #000; }
        #viewer { width: 100%; height: 100%; }
        
        /* UI Elements */
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .list-item { padding: 12px; border-bottom: 1px solid #f1f1f1; cursor: pointer; transition: 0.2s; }
        .list-item:hover { background: #f8f9fa; border-left: 4px solid var(--accent); }
        
        /* Edit Overlay */
        .edit-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:10; display:none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .status-text { font-size: 0.85em; color: var(--accent); text-align: center; margin-top: 8px; font-weight: bold; }
        
        /* Source Selection */
        .source-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; }
        .source-tab { flex: 1; padding: 12px; background: transparent; border: none; cursor: pointer; font-weight: 600; color: #6c757d; transition: 0.2s; border-bottom: 3px solid transparent; }
        .source-tab:hover { background: #f8f9fa; }
        .source-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        /* Upload/Link Sections */
        .upload-section { display: none; }
        .upload-section.active { display: block; }
        
        input[type="text"], input[type="url"] { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0 20px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        
        .upload-zone { border: 2px dashed #ddd; padding: 15px; border-radius: 8px; text-align: center; background: #f8f9fa; cursor: pointer; transition: 0.2s; }
        .upload-zone:hover { border-color: var(--accent); background: #e9f5ff; }
        
        .preview-img { max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; margin-top: 10px; }
        
        .progress-bar { width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="map-container"></div>
    <div class="panel">
        <h3 style="margin-top:0;">360¬∞ Locations</h3>
        <button class="btn btn-primary" onclick="addNewPoint()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î 360 ‡πÉ‡∏´‡∏°‡πà</button>
        <div id="tree-list" style="margin-top: 15px;"></div>
    </div>

    <div id="edit-panel" class="edit-overlay">
        <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î 360</h3>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
        <input type="text" id="pName" oninput="updateName()">
        
        <!-- Source Selection Tabs -->
        <div class="source-tabs">
            <button class="source-tab active" onclick="switchSource('upload')">üì§ Upload ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
            <button class="source-tab" onclick="switchSource('drive')">üìÅ Google Drive</button>
        </div>
        
        <!-- Upload Section -->
        <div id="uploadSection" class="upload-section active">
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <p style="margin-top:0;">üåê ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û Equirectangular (2:1)</p>
                <button class="btn btn-primary" type="button">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û 360</button>
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="uploadStatus" class="status-text"></div>
                <img id="previewUpload" class="preview-img" style="display:none;">
            </div>
        </div>
        
        <!-- Google Drive Section -->
        <div id="driveSection" class="upload-section">
            <p style="color: #6c757d; font-size: 0.9em; margin-top: 0;">
                üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Google Drive ‚Üí ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤ ‚Üí Share ‚Üí Anyone with the link ‚Üí Copy link
            </p>
            <label>Google Drive Share Link:</label>
            <input type="url" id="driveLink" placeholder="https://drive.google.com/file/d/..." oninput="updateDriveLink()">
            <button class="btn btn-secondary" onclick="previewDriveImage()">üîç ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            <div id="driveStatus" class="status-text"></div>
            <img id="previewDrive" class="preview-img" style="display:none;">
        </div>

        <button class="btn" style="background:#f1f1f1; margin-top:30px;" onclick="exitEdit()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button class="btn" style="background:var(--red); color:white;" onclick="deletePoint()">‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>
    </div>
</div>

<div id="viewer-container">
    <div id="viewer"></div>
</div>

<script>
// --- CONFIGURATION ---
const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID';
const GOOGLE_API_KEY = 'YOUR_API_KEY';
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    appId: "YOUR_APP_ID"
};

// Global Variables
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let tokenClient, map, viewer, dataList = [], curId = null, currentSource = 'upload';

window.onload = () => {
    initMap();
    loadFirebaseData();
    initGoogleAuth();
};

function initGoogleAuth() {
    gapi.load('client', async () => {
        await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
    });
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: '' 
    });
}

function initMap() {
    map = L.map('map-container', { attributionControl: false }).setView([13.75, 100.5], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

function loadFirebaseData() {
    db.ref('points').on('value', (snap) => {
        const val = snap.val();
        dataList = val ? Object.keys(val).map(key => ({...val[key], id: key})) : [];
        renderTree();
    });
}

// --- Source Switching ---
function switchSource(source) {
    currentSource = source;
    
    // Update tabs
    document.querySelectorAll('.source-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // Update sections
    document.querySelectorAll('.upload-section').forEach(sec => sec.classList.remove('active'));
    if (source === 'upload') {
        document.getElementById('uploadSection').classList.add('active');
    } else {
        document.getElementById('driveSection').classList.add('active');
    }
}

// --- 360 Viewer Management ---
function update360Viewer(url) {
    if (viewer) viewer.destroy();
    if (!url) {
        document.getElementById('viewer').innerHTML = '<div style="color:white; text-align:center; padding-top:20%;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û 360 ‡∏≠‡∏á‡∏®‡∏≤</div>';
        return;
    }
    
    viewer = pannellum.viewer('viewer', {
        type: "equirectangular",
        panorama: url,
        autoLoad: true,
        crossOrigin: "anonymous",
        showControls: true,
        compass: true,
        autoRotate: -2,
        mouseZoom: true,
        hfov: 100
    });
}

// --- Upload & Google Drive (Original Function) ---
async function handleFileUpload(input) {
    const file = input.files[0];
    if (!file || !curId) return;

    const status = document.getElementById('uploadStatus');
    const progress = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const preview = document.getElementById('previewUpload');
    
    status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive...";
    progress.style.display = 'block';
    progressFill.style.width = '30%';

    try {
        const driveLink = await uploadToDrive(file);
        progressFill.style.width = '80%';
        
        await db.ref(`points/${curId}`).update({ 
            image: driveLink,
            imageSource: 'upload'
        });
        
        progressFill.style.width = '100%';
        status.innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
        
        // Show preview and update viewer
        preview.src = driveLink;
        preview.style.display = 'block';
        update360Viewer(driveLink);
        
        setTimeout(() => {
            progress.style.display = 'none';
            progressFill.style.width = '0%';
        }, 2000);
        
    } catch (e) {
        status.innerText = "‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message;
        progress.style.display = 'none';
    } finally {
        input.value = '';
    }
}

async function uploadToDrive(file) {
    return new Promise((resolve, reject) => {
        tokenClient.callback = async (resp) => {
            if (resp.error) reject(resp);
            
            const metadata = { name: `pano_${Date.now()}.jpg`, mimeType: 'image/jpeg' };
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', file);

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + resp.access_token },
                body: formData
            });
            const driveFile = await res.json();

            // Set Permission: Public Read
            await fetch(`https://www.googleapis.com/drive/v3/files/${driveFile.id}/permissions`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + resp.access_token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'reader', type: 'anyone' })
            });

            // Return Direct Link
            resolve(`https://drive.google.com/uc?export=view&id=${driveFile.id}`);
        };
        tokenClient.requestAccessToken({ prompt: 'consent' });
    });
}

// --- Google Drive Link Handler ---
let driveLinkTimer;
function updateDriveLink() {
    clearTimeout(driveLinkTimer);
    const link = document.getElementById('driveLink').value.trim();
    
    driveLinkTimer = setTimeout(async () => {
        if (!link || !curId) return;
        
        const convertedLink = convertDriveLink(link);
        await db.ref(`points/${curId}`).update({ 
            image: convertedLink,
            imageSource: 'drive'
        });
        
        document.getElementById('driveStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß";
        setTimeout(() => {
            document.getElementById('driveStatus').innerText = "";
        }, 2000);
    }, 1000);
}

function convertDriveLink(link) {
    // Convert Google Drive share link to direct link
    const match = link.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (match) {
        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
    }
    return link;
}

function previewDriveImage() {
    const link = document.getElementById('driveLink').value.trim();
    if (!link) {
        alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡∏Å‡πà‡∏≠‡∏ô');
        return;
    }
    
    const convertedLink = convertDriveLink(link);
    const preview = document.getElementById('previewDrive');
    const status = document.getElementById('driveStatus');
    
    status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...";
    
    preview.onload = () => {
        preview.style.display = 'block';
        status.innerText = "‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        update360Viewer(convertedLink);
    };
    
    preview.onerror = () => {
        status.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå)";
        preview.style.display = 'none';
    };
    
    preview.src = convertedLink;
}

// --- UI Logic ---
function renderTree() {
    const list = document.getElementById('tree-list');
    list.innerHTML = dataList.map(p => {
        const sourceIcon = p.imageSource === 'drive' ? 'üìÅ' : (p.imageSource === 'upload' ? 'üì§' : '');
        return `
            <div class="list-item" onclick="enterEdit('${p.id}')">
                üìç ${p.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'} ${p.image ? 'üåê ' + sourceIcon : ''}
            </div>
        `;
    }).join('');
}

function enterEdit(id) {
    curId = id;
    const p = dataList.find(x => x.id === id);
    document.getElementById('edit-panel').style.display = 'block';
    document.getElementById('pName').value = p.name || '';
    document.getElementById('uploadStatus').innerText = "";
    document.getElementById('driveStatus').innerText = "";
    document.getElementById('progressBar').style.display = 'none';
    document.getElementById('progressFill').style.width = '0%';
    
    // Reset previews
    document.getElementById('previewUpload').style.display = 'none';
    document.getElementById('previewDrive').style.display = 'none';
    document.getElementById('driveLink').value = '';
    
    // Set active tab based on source
    document.querySelectorAll('.source-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.upload-section').forEach(sec => sec.classList.remove('active'));
    
    if (p.imageSource === 'drive') {
        currentSource = 'drive';
        document.querySelectorAll('.source-tab')[1].classList.add('active');
        document.getElementById('driveSection').classList.add('active');
        document.getElementById('driveLink').value = p.image || '';
        if (p.image) {
            document.getElementById('previewDrive').src = p.image;
            document.getElementById('previewDrive').style.display = 'block';
        }
    } else {
        currentSource = 'upload';
        document.querySelectorAll('.source-tab')[0].classList.add('active');
        document.getElementById('uploadSection').classList.add('active');
        if (p.image && p.imageSource === 'upload') {
            document.getElementById('previewUpload').src = p.image;
            document.getElementById('previewUpload').style.display = 'block';
        }
    }
    
    update360Viewer(p.image);
    map.panTo([p.lat, p.lon]);
}

function addNewPoint() {
    const center = map.getCenter();
    db.ref('points').push({
        name: "‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà 360",
        lat: center.lat,
        lon: center.lng,
        image: "",
        imageSource: "upload"
    });
}

let typingTimer;
function updateName() {
    clearTimeout(typingTimer);
    const newName = document.getElementById('pName').value;
    typingTimer = setTimeout(() => {
        if (curId) db.ref(`points/${curId}`).update({ name: newName });
    }, 500);
}

function deletePoint() {
    if (confirm('‡∏•‡∏ö‡∏à‡∏∏‡∏î 360 ‡∏ô‡∏µ‡πâ?')) {
        db.ref(`points/${curId}`).remove();
        exitEdit();
    }
}

function exitEdit() {
    document.getElementById('edit-panel').style.display = 'none';
    curId = null;
    if (viewer) viewer.destroy();
}
</script>
</body>
</html>
