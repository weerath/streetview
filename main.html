<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// --- CONFIGURATION ---
const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'YOUR_API_KEY';
const firebaseConfig = { /* ‡πÉ‡∏™‡πà Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */ };

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let tokenClient;
let currentPanoFile = null;

// 1. Initialize Google Auth
function gapiStart() {
    gapi.load('client', async () => {
        await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
    });
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: '', 
    });
}
window.onload = gapiStart;

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (Browse Local File)
function triggerUpload() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        currentPanoFile = e.target.files[0];
        if(currentPanoFile) startUploadProcess();
    };
    input.click();
}

// 3. ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive
async function startUploadProcess() {
    tokenClient.callback = async (response) => {
        if (response.error) return;

        showStatus('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive...', '#2196f3');

        // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        const metadata = { name: `pano_${Date.now()}.jpg`, mimeType: 'image/jpeg' };
        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        formData.append('file', currentPanoFile);

        const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + response.access_token },
            body: formData
        });
        const driveFile = await uploadRes.json();

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission ‡πÄ‡∏õ‡πá‡∏ô Public (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Pannellum ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
        await fetch(`https://www.googleapis.com/drive/v3/files/${driveFile.id}/permissions`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + response.access_token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: 'reader', type: 'anyone' })
        });

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Link ‡∏•‡∏á Firebase
        const directLink = `https://docs.google.com/uc?export=view&id=${driveFile.id}`;
        updatePointImage(directLink);
    };

    // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Access Token
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        tokenClient.requestAccessToken({ prompt: '' });
    }
}

async function updatePointImage(link) {
    const p = data.find(x => x.id === curId);
    p.image = link;
    await db.ref('points').set(data); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡πÑ‡∏õ Firebase
    loadViewer(); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏π‡∏õ 360 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    showStatus('‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '#4caf50');
}
</script>

<div class="upload-zone" onclick="triggerUpload()">
    <div>üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ 360 ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive</div>
</div>
