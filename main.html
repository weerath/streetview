<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>Master SV Editor ‚Äì Google Drive Only</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- LIB -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<!-- GOOGLE -->
<script src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#000}
#top{padding:10px;background:#111;color:#fff}
#viewer,#map{width:100%;height:calc(100vh - 50px)}
button{padding:8px;margin:5px}
</style>
</head>

<body>
<div id="top">
<button onclick="login()">üîê Login Google</button>
<button onclick="loadDB()">üì• Load</button>
<button onclick="saveDB()">üíæ Save</button>
<input type="file" id="file" accept="image/*" onchange="uploadImage()">
<span id="status"></span>
</div>

<div id="viewer"></div>

<script>
/* ===== CONFIG ===== */
const CLIENT_ID = "740899492808-qoi3pjpfbe2sp8e8e4q43tr2sm0cnuhl.apps.googleusercontent.com";
const FOLDER_ID = "1PQWNipWJ3f6HvS_g8j3eC4_eKJ7NVC79";
const SCOPES = "https://www.googleapis.com/auth/drive.file";

let tokenClient;
let accessToken = null;
let data = [];
let viewer;

/* ===== INIT GOOGLE ===== */
function initGoogle(){
  gapi.load("client", async ()=>{
    await gapi.client.init({
      discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
    });
  });

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (t)=>{
      accessToken = t.access_token;
      gapi.client.setToken(t);
      log("Login OK");
    }
  });
}
initGoogle();

/* ===== AUTH ===== */
function login(){
  tokenClient.requestAccessToken();
}

/* ===== DRIVE UTILS ===== */
async function findFile(name){
  const r = await gapi.client.drive.files.list({
    q: `'${FOLDER_ID}' in parents and name='${name}' and trashed=false`
  });
  return r.result.files[0];
}

async function loadDB(){
  const f = await findFile("data.json");
  if(!f){ data=[]; log("DB empty"); return; }

  const res = await fetch(
    `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media`,
    { headers:{Authorization:`Bearer ${accessToken}`} }
  );
  data = await res.json();
  log("Loaded "+data.length+" points");
  if(data[0]?.image) loadViewer(data[0].image);
}

async function saveDB(){
  let f = await findFile("data.json");
  const body = JSON.stringify(data,null,2);

  if(!f){
    await gapi.client.drive.files.create({
      resource:{name:"data.json",parents:[FOLDER_ID]},
      media:{mimeType:"application/json",body}
    });
  }else{
    await gapi.client.request({
      path:`/upload/drive/v3/files/${f.id}`,
      method:"PATCH",
      params:{uploadType:"media"},
      body
    });
  }
  log("Saved DB");
}

async function uploadImage(){
  const file = document.getElementById("file").files[0];
  if(!file) return;

  const meta = {name:file.name,parents:[FOLDER_ID]};
  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(meta)],{type:"application/json"}));
  form.append("file", file);

  const r = await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",
    {method:"POST",headers:{Authorization:`Bearer ${accessToken}`},body:form}
  );
  const j = await r.json();
  const imgUrl = `https://drive.google.com/uc?id=${j.id}`;

  data.push({id:"p"+Date.now(),name:file.name,image:imgUrl,hotSpots:[]});
  loadViewer(imgUrl);
  log("Image uploaded");
}

/* ===== VIEWER ===== */
function loadViewer(url){
  if(viewer) viewer.destroy();
  viewer = pannellum.viewer("viewer",{
    type:"equirectangular",
    panorama:url,
    autoLoad:true
  });
}

/* ===== UI ===== */
function log(t){document.getElementById("status").innerText=t;}
</script>
</body>
</html>
