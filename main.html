<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>360 Viewer - Firebase & Google Drive</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --accent: #2196f3; --red: #ff5252; --dark: #1a1a1a; }
        body { margin: 0; height: 100vh; display: flex; font-family: sans-serif; overflow: hidden; background: #000; }
        #sidebar { width: 340px; height: 100%; background: #fff; z-index: 2000; border-right: 1px solid #ddd; display: flex; flex-direction: column; transition: 0.3s; }
        #viewer-container { flex-grow: 1; position: relative; }
        #map-full { width: 100%; height: 300px; }
        #viewer { width: 100%; height: 100%; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: var(--red); color: white; }
        .status-toast { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; color: white; z-index: 9999; display: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="map-full"></div>
    <div style="padding: 15px; overflow-y: auto;">
        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î 360</h3>
        <button class="btn btn-blue" onclick="addNewPoint()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà</button>
        <div id="tree-list"></div>
    </div>
</div>

<div id="viewer-container">
    <div id="viewer"></div>
    <div id="controls" style="position: absolute; bottom: 20px; left: 20px; z-index: 1000;">
        <button class="btn btn-blue" onclick="editPointImage()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ (Google Drive)</button>
    </div>
</div>

<div id="status" class="status-toast"></div>

<script>
// --- CONFIGURATION: ‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ---
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};
// ---------------------------------------------------

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let data = [], map, viewer, curId = null, markers = [];

// 1. Initial Load
window.onload = () => {
    initMap();
    loadFromFirebase();
};

function initMap() {
    map = L.map('map-full', { attributionControl: false }).setView([13.75, 100.5], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

// 2. Firebase Data Management
function loadFromFirebase() {
    db.ref('points').on('value', (snapshot) => {
        const val = snapshot.val();
        data = val ? Object.values(val) : [];
        renderTree();
        updateMarkers();
    });
}

function saveToFirebase() {
    db.ref('points').set(data)
        .then(() => showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '#4caf50'))
        .catch(err => showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, '#f44336'));
}

// 3. UI Rendering
function renderTree() {
    const list = document.getElementById('tree-list');
    list.innerHTML = data.map(p => `
        <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="selectPoint('${p.id}')">
            üìç ${p.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}
            <button class="btn-red" style="float:right" onclick="deletePoint('${p.id}')">‡∏•‡∏ö</button>
        </div>
    `).join('');
}

function updateMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = data.map(p => {
        const m = L.marker([p.lat, p.lon]).addTo(map).on('click', () => selectPoint(p.id));
        return m;
    });
}

// 4. Core Logic
function selectPoint(id) {
    curId = id;
    const p = data.find(x => x.id === id);
    if (!p) return;
    map.panTo([p.lat, p.lon]);
    loadViewer(p.image);
}

function loadViewer(imgUrl) {
    if (viewer) viewer.destroy();
    viewer = pannellum.viewer('viewer', {
        type: "equirectangular",
        panorama: imgUrl || "https://pannellum.org/images/alma.jpg",
        autoLoad: true
    });
}

function addNewPoint() {
    const center = map.getCenter();
    const newPoint = {
        id: "p" + Date.now(),
        name: "‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà " + (data.length + 1),
        lat: center.lat,
        lon: center.lng,
        image: ""
    };
    data.push(newPoint);
    saveToFirebase();
}

function deletePoint(id) {
    if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) {
        data = data.filter(x => x.id !== id);
        saveToFirebase();
    }
}

// 5. Google Drive Integration
function editPointImage() {
    if (!curId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô');
    const url = prompt("‡∏ß‡∏≤‡∏á Google Drive Share Link ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà:");
    if (url) {
        const p = data.find(x => x.id === curId);
        p.image = transformDriveUrl(url);
        saveToFirebase();
        loadViewer(p.image);
    }
}

function transformDriveUrl(url) {
    if (url.includes('drive.google.com')) {
        const parts = url.split('/d/');
        if (parts.length > 1) {
            const id = parts[1].split('/')[0];
            return `https://docs.google.com/uc?export=view&id=${id}`;
        }
    }
    return url;
}

function showStatus(msg, color) {
    const s = document.getElementById('status');
    s.innerText = msg;
    s.style.background = color;
    s.style.display = 'block';
    setTimeout(() => s.style.display = 'none', 3000);
}
</script>

</body>
</html>
