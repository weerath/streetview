<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master SV Editor - Google Drive & 360 Viewer</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --accent: #2196f3; --red: #ff5252; --dark: #1a1a1a; }
        body { margin: 0; height: 100vh; display: flex; font-family: sans-serif; overflow: hidden; background: #000; }
        #sidebar { width: 340px; height: 100%; background: #fff; z-index: 2000; border-right: 1px solid #ddd; display: flex; flex-direction: column; position: relative; }
        #viewer-container { flex-grow: 1; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        #viewer { width: 100%; height: 100%; }
        #map-full { height: 250px; width: 100%; }
        .panel { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-blue { background: var(--accent); color: white; }
        .edit-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:10; display:none; padding: 15px; box-sizing: border-box; }
        .list-item { padding:10px; border-bottom:1px solid #eee; cursor:pointer; display: flex; justify-content: space-between; align-items: center; }
        .list-item:hover { background: #f9f9f9; }
        #preview-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="map-full"></div>
    <div class="panel">
        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <button class="btn btn-blue" onclick="addNewPoint()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)</button>
        <div id="tree-list" style="margin-top: 15px;"></div>
    </div>

    <div id="edit-panel" class="edit-overlay">
        <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î</h3>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
        <input type="text" id="pName" style="width:100%; padding:8px; margin-bottom:15px; box-sizing: border-box;" oninput="updateName()">
        
        <div style="margin-top:10px; border: 1px dashed #ccc; padding: 10px; border-radius: 8px;">
            <p style="margin-top:0;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏õ‡∏Å‡∏ï‡∏¥/360):</p>
            <button class="btn btn-blue" onclick="document.getElementById('fileInput').click()">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
            <p id="uploadStatus" style="font-size:0.85em; color:var(--accent); text-align:center; margin-top:10px;"></p>
        </div>

        <button class="btn" style="background:#eee;" onclick="exitEdit()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button class="btn" style="background:var(--red); color:white; margin-top:20px;" onclick="deletePoint()">‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div id="viewer-container">
    <div id="viewer"></div>
</div>

<script>
// --- CONFIGURATION (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID';
const GOOGLE_API_KEY = 'YOUR_API_KEY';
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    appId: "YOUR_APP_ID"
};

// Initialize
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let tokenClient, map, viewer, dataList = [], curId = null;

window.onload = () => {
    initMap();
    loadFirebaseData();
    initGoogleAuth();
};

function initGoogleAuth() {
    gapi.load('client', async () => {
        await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
    });
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: '' 
    });
}

function initMap() {
    map = L.map('map-full', { attributionControl: false }).setView([13.75, 100.5], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

function loadFirebaseData() {
    db.ref('points').on('value', (snap) => {
        const rawData = snap.val();
        dataList = rawData ? Object.keys(rawData).map(key => ({...rawData[key], id: key})) : [];
        renderTree();
    });
}

// --- ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏û (‡πÅ‡∏¢‡∏Å 360 ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏Å‡∏ï‡∏¥) ---
async function renderImageContent(url) {
    const container = document.getElementById('viewer');
    container.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á Viewer ‡πÄ‡∏î‡∏¥‡∏°
    if (viewer) { viewer.destroy(); viewer = null; }

    if (!url) {
        container.innerHTML = '<p style="color:#666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>';
        return;
    }

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = url;
    
    img.onload = () => {
        const ratio = img.width / img.height;
        // ‡∏™‡∏π‡∏ï‡∏£: ‡∏ñ‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏π‡∏á (‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô 10%) = 360 ‡∏≠‡∏á‡∏®‡∏≤
        if (Math.abs(ratio - 2) < 0.2) {
            viewer = pannellum.viewer('viewer', {
                type: "equirectangular",
                panorama: url,
                autoLoad: true
            });
        } else {
            container.innerHTML = `<img src="${url}" id="preview-img">`;
        }
    };
    
    img.onerror = () => {
        container.innerHTML = '<p style="color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Google Drive ‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS ‡∏´‡∏£‡∏∑‡∏≠ Link ‡πÄ‡∏™‡∏µ‡∏¢)</p>';
    };
}

// --- ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Google Drive ---
async function handleFileUpload(input) {
    const file = input.files[0];
    if (!file || !curId) return;

    const status = document.getElementById('uploadStatus');
    status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Google Drive...";

    try {
        const driveLink = await uploadToDrive(file);
        await db.ref(`points/${curId}`).update({ image: driveLink });
        status.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
        renderImageContent(driveLink);
    } catch (e) {
        status.innerText = "‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message;
    } finally {
        input.value = '';
    }
}

async function uploadToDrive(file) {
    return new Promise((resolve, reject) => {
        tokenClient.callback = async (response) => {
            if (response.error) reject(response);

            const metadata = { name: `img_${Date.now()}.jpg`, mimeType: 'image/jpeg' };
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', file);

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + response.access_token },
                body: formData
            });
            const driveFile = await res.json();

            // Set Permission: Anyone with link can view
            await fetch(`https://www.googleapis.com/drive/v3/files/${driveFile.id}/permissions`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + response.access_token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'reader', type: 'anyone' })
            });

            resolve(`https://docs.google.com/uc?export=view&id=${driveFile.id}`);
        };
        tokenClient.requestAccessToken({ prompt: gapi.client.getToken() === null ? 'consent' : '' });
    });
}

// --- UI Functions ---
function renderTree() {
    const list = document.getElementById('tree-list');
    list.innerHTML = dataList.map(p => `
        <div class="list-item" onclick="enterEdit('${p.id}')">
            <span>üìç ${p.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</span>
            <span style="font-size: 0.7em; color: #999;">${p.image ? 'üñºÔ∏è ‡∏°‡∏µ‡∏£‡∏π‡∏õ' : '‚ö™ ‡∏ß‡πà‡∏≤‡∏á'}</span>
        </div>
    `).join('');
}

function enterEdit(id) {
    curId = id;
    const p = dataList.find(x => x.id === id);
    document.getElementById('edit-panel').style.display = 'block';
    document.getElementById('pName').value = p.name;
    document.getElementById('uploadStatus').innerText = "";
    renderImageContent(p.image);
    map.panTo([p.lat, p.lon]);
}

function addNewPoint() {
    const center = map.getCenter();
    const newPoint = {
        name: "‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà " + new Date().toLocaleTimeString(),
        lat: center.lat,
        lon: center.lng,
        image: "",
        createdAt: Date.now()
    };
    db.ref('points').push(newPoint);
}

let typingTimer;
function updateName() {
    clearTimeout(typingTimer);
    const newName = document.getElementById('pName').value;
    typingTimer = setTimeout(() => {
        if (curId) db.ref(`points/${curId}`).update({ name: newName });
    }, 500);
}

function deletePoint() {
    if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ?')) {
        db.ref(`points/${curId}`).remove();
        exitEdit();
    }
}

function exitEdit() {
    document.getElementById('edit-panel').style.display = 'none';
    curId = null;
    document.getElementById('viewer').innerHTML = '';
}
</script>
</body>
</html>
