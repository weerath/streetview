<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>360 Editor - Local Sandbox</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        :root { --accent: #2196f3; --red: #ff5252; --dark: #1a1a1a; }
        body { margin: 0; height: 100vh; display: flex; font-family: -apple-system, sans-serif; overflow: hidden; background: #000; }
        #sidebar { width: 340px; height: 100%; background: #fff; z-index: 2000; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #map { height: 200px; width: 100%; border-bottom: 1px solid #ddd; }
        .panel-content { padding: 15px; overflow-y: auto; flex-grow: 1; }
        #viewer-container { flex-grow: 1; position: relative; background: #000; }
        #viewer { width: 100%; height: 100%; }
        .edit-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:#fff; z-index:100; display:none; padding:15px; box-sizing:border-box; overflow-y:auto; }
        .btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; width: 100%; margin-bottom: 10px; }
        .btn-blue { background: var(--accent); color: white; }
        .list-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .list-item:hover { background: #f5f5f5; }
        .badge { background: #eee; padding: 2px 6px; border-radius: 10px; font-size: 11px; }
        input, select { width: 100%; padding: 8px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="map"></div>
    <div class="panel-content">
        <h3 style="margin-top:0">üìç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î 360</h3>
        <button class="btn btn-blue" onclick="addNewPoint()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà</button>
        <div id="tree-list"></div>
    </div>

    <div id="edit-panel" class="edit-overlay">
        <h3 id="edit-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î</h3>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
        <input type="text" id="pName" oninput="updateName()">
        
        <label>‡∏†‡∏≤‡∏û 360 (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î):</label>
        <input type="file" accept="image/*" onchange="previewImage(this)">
        
        <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
            <small>‡∏û‡∏¥‡∏Å‡∏±‡∏î: <span id="pCoords">-</span></small>
        </div>

        <button class="btn btn-blue" onclick="exitEdit()">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button class="btn" style="background:#f1f1f1" onclick="alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Hotspot ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Hotspot (Coming Soon)</button>
        <button class="btn" style="background:var(--red); color:white" onclick="deletePoint()">üóëÔ∏è ‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>
    </div>
</div>

<div id="viewer-container">
    <div id="viewer"></div>
</div>

<script>
// 1. Mock Data (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
let data = [
    { id: 'p1', name: "‡∏•‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á (Demo)", lat: 13.7515, lon: 100.4927, image: "https://pannellum.org/images/alma.jpg" },
    { id: 'p2', name: "‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (Demo)", lat: 13.7500, lon: 100.5000, image: "https://pannellum.org/images/cerro-toco-0.jpg" }
];

let map, viewer, curId = null;

window.onload = () => {
    initMap();
    renderTree();
    loadViewer(); // ‡πÇ‡∏´‡∏•‡∏î viewer ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
};

function initMap() {
    map = L.map('map', { attributionControl: false }).setView([13.75, 100.5], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
    map.on('click', (e) => {
        if (curId) {
            const p = data.find(x => x.id === curId);
            p.lat = e.latlng.lat;
            p.lon = e.latlng.lng;
            document.getElementById('pCoords').innerText = p.lat.toFixed(5) + ", " + p.lon.toFixed(5);
            renderTree();
            updateMarkers();
        }
    });
    updateMarkers();
}

function updateMarkers() {
    map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
    data.forEach(p => {
        L.marker([p.lat, p.lon]).addTo(map).on('click', () => enterEdit(p.id));
    });
}

function renderTree() {
    const list = document.getElementById('tree-list');
    list.innerHTML = data.map(p => `
        <div class="list-item" onclick="enterEdit('${p.id}')">
            <span>üìç ${p.name}</span>
            <span class="badge">${p.image ? '‡∏°‡∏µ‡∏†‡∏≤‡∏û' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û'}</span>
        </div>
    `).join('');
}

function loadViewer() {
    if (viewer) viewer.destroy();
    const p = data.find(x => x.id === curId) || data[0];
    
    if (!p || !p.image) {
        document.getElementById('viewer').innerHTML = '<div style="color:white; text-align:center; padding-top:20%">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>';
        return;
    }

    viewer = pannellum.viewer('viewer', {
        type: "equirectangular",
        panorama: p.image,
        autoLoad: true,
        compass: true
    });
}

function enterEdit(id) {
    curId = id;
    const p = data.find(x => x.id === id);
    document.getElementById('edit-panel').style.display = 'block';
    document.getElementById('pName').value = p.name;
    document.getElementById('pCoords').innerText = p.lat.toFixed(5) + ", " + p.lon.toFixed(5);
    loadViewer();
    map.panTo([p.lat, p.lon]);
}

function exitEdit() {
    document.getElementById('edit-panel').style.display = 'none';
    curId = null;
}

function addNewPoint() {
    const center = map.getCenter();
    const id = 'p' + Date.now();
    data.push({
        id: id,
        name: "‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà " + (data.length + 1),
        lat: center.lat,
        lon: center.lng,
        image: "" // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û
    });
    renderTree();
    updateMarkers();
    enterEdit(id);
}

function updateName() {
    if (!curId) return;
    data.find(x => x.id === curId).name = document.getElementById('pName').value;
    renderTree();
}

function deletePoint() {
    if (confirm('‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        data = data.filter(x => x.id !== curId);
        renderTree();
        updateMarkers();
        exitEdit();
        loadViewer();
    }
}

function previewImage(input) {
    if (input.files && input.files[0] && curId) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const p = data.find(x => x.id === curId);
            p.image = e.target.result; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô Base64 ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô Memory
            loadViewer();
            renderTree();
        };
        reader.readAsDataURL(input.files[0]);
    }
}
</script>
</body>
</html>
